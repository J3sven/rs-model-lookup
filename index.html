<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runescape Model Search</title>
    <style>
      /* Global styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
      body {
        background-color: #212529;
        color: #fff;
      }
      .container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
        background-color: #343a40;
        border-radius: 10px;
      }
      /* Form styles */
      form {
        display: flex;
        gap: 1rem; /* Maintain gap between elements */
        padding: 1rem; /* Add padding to the form */
      }
      label {
        flex-shrink: 0; /* Prevent label from shrinking */
        margin-right: 0.5rem; /* Add some space between label and select */
        text-align: right;
        line-height: 2.5em; /* Vertically center label with select menu */
      }
      select,
        input[type="text"] {
        padding: 0.5em;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 100%;
      }
      button {
        padding: 0.5em 1em;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      /* Loading indicator */
      .loading {
        color: #ffc107;
        font-style: italic;
      }
      /* Table styles */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 0.5em;
        border: 1px solid #444;
        text-align: left;
      }
      th {
         background-color: #29323a;
      }
      .header {
        background-color: #343a40;
        color: white;
        text-align: center;
        padding: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>RSHD Model Search</h1>
    </div>
    <div class="container">
      <form>
        <select id="data-file" name="data-file" required>
          <option value="">Loading data sources...</option>
        </select>
        <input type="text" id="search-box" placeholder="Search models">
        <button type="submit">Search</button>
      </form>
      <div class="results">
        <table>
          <thead>
            <tr>
              <th>Index</th>
              <th>Label</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>
      <script>
        const searchForm = document.querySelector("form");
        const resultsBody = document.getElementById("results-body");
        const searchBox = document.getElementById("search-box");
        const dataFileSelect = document.getElementById("data-file");

        // Load available data sources on page load
        document.addEventListener('DOMContentLoaded', loadDataSources);

        async function loadDataSources() {
          try {
            // Fetch the index file that contains list of available data files
            const response = await fetch('data/index.json');
            const dataSources = await response.json();
            
            // Clear the loading option
            dataFileSelect.innerHTML = '<option value="">Select data source</option>';
            
            // Populate dropdown with available data sources
            dataSources.forEach(source => {
              const option = document.createElement('option');
              option.value = source.value;
              option.textContent = source.label || source.value;
              dataFileSelect.appendChild(option);
            });
            
          } catch (error) {
            console.error('Error loading data sources:', error);
            dataFileSelect.innerHTML = '<option value="">Error loading data sources</option>';
          }
        }

        searchForm.addEventListener("submit", (event) => {
          event.preventDefault(); // Prevent default form submission

          const dataFile = dataFileSelect.value;
          const searchTerm = searchBox.value.toLowerCase(); // Convert search term to lowercase

          if (!dataFile) {
            alert("Please select a data file.");
            return;
          }

          const filename = `data/${dataFile}.json`; // Construct filename based on selection
          fetch(filename)
            .then(response => response.json())
            .then(data => {
              const results = fuzzySearch(searchTerm, data);
              displayData(results);
            })
            .catch(error => {
              console.error("Error fetching data:", error);
              alert(`Failed to retrieve data, data file ${dataFile} may not exist.`);
            });
        });

        function fuzzySearch(searchTerm, data) {
          // Implement your fuzzy search logic here
          // This is a basic example using string search
          // Replace with a fuzzy search library like Fuse.js
          return data.filter(item => item.label.toLowerCase().includes(searchTerm));
        }

        function displayData(data) {
          let output = "";
          if (data.length === 0) {
            output = "<tr><td colspan='2'>No results found, perhaps try a different data source</td></tr>";
          } else {
            // Sort by index in ascending order (low to high)
            const sortedData = data.sort((a, b) => a.index - b.index);
            
            sortedData.forEach(item => {
              output += `<tr>
                <td>${item.index}</td>
                <td>${item.label}</td>
            </tr>`;
            });
          }
          resultsBody.innerHTML = output;
        }

        // Function to create and display the modal popup
        function showCopySuccessModal(indexValue) {
          const modal = document.createElement("div");
          modal.classList.add("copy-success-modal");
          modal.textContent = `Index ${indexValue} Copied!`;
          document.body.appendChild(modal);

          // Automatically remove the modal after 2 seconds
          setTimeout(() => {
            modal.remove();
          }, 2000);
        }

        resultsBody.addEventListener("click", (event) => {
          const target = event.target;
          if (target.tagName !== "TD") return; // Check if clicked element is a table cell (TD)

          // Get the index value from the cell content
          const indexValue = target.textContent;

          // Use the Clipboard API to copy the index value
          navigator.clipboard.writeText(indexValue)
            .then(() => { // No argument needed here
              showCopySuccessModal(indexValue);
            })
            .catch(err => {
              console.error("Failed to copy index:", err);
            });
        });

        // Style the modal (optional)
        const style = document.createElement("style");
        style.textContent = `.copy-success-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #2ECC71;
        color: white;
        padding: 1rem;
        border-radius: 5px;
        font-size: 1.2rem;
        z-index: 999; /* Ensure modal appears above other elements */
        }`;
        document.head.appendChild(style);
      </script>
    </div>
  </body>
</html>